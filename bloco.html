<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Leituras do Bloco | Leitura de HidrÃ´metro</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="logorecibo.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  
  <!-- SCRIPT CORRIGIDO: Todas as funÃ§Ãµes necessÃ¡rias agora estÃ£o aqui -->
  <script>
    // ProteÃ§Ã£o de login
    if (localStorage.getItem("logado") !== "true") location.href = "index.html";

    // Verifica biblioteca XLSX
    if (typeof XLSX === 'undefined') {
      alert("Biblioteca XLSX nÃ£o carregada. Verifique a conexÃ£o ou recarregue a pÃ¡gina.");
    }

    // ==================== FUNÃ‡Ã•ES AUXILIARES ====================
    
    function carregarBlocos() {
      return JSON.parse(localStorage.getItem("blocos")) || [];
    }
    
    function salvarBlocos(blocos) {
      localStorage.setItem("blocos", JSON.stringify(blocos));
    }
    
    function mesAtual() {
      const hoje = new Date();
      return `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, "0")}`;
    }
    
    function formatarMesLabel(mes) {
      const [ano, numeroMes] = mes.split("-");
      const date = new Date(`${ano}-${(numeroMes || "01")}-01`);
      return date.toLocaleString("pt-BR", { month: "long", year: "numeric" });
    }
    
    function showToast(message, isError = false) {
      const toast = document.createElement("div");
      toast.className = `toast ${isError ? "error" : "success"}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
    
    function getTarifa(bloco) {
      return bloco.tarifaConfig || { minimo: 64.60, faixa_11_20: 8.94, faixa_21_50: 13.82 };
    }
    
    function calcularValorEscalonado(m3, tarifa) {
      const { minimo, faixa_11_20 } = tarifa;
      if (m3 <= 10) return minimo;
      return minimo + (m3 - 10) * faixa_11_20;
    }

    // ==================== FUNÃ‡Ã•ES DOS MODAIS ====================
    
    function abrirModalSalvarHistorico() {
      const modal = document.getElementById('modal-salvar-historico');
      const mesInput = document.getElementById('mes-salvar-historico');
      mesInput.value = mesAtual();
      modal.style.display = 'block';
    }
    
    function fecharModalSalvarHistorico() {
      document.getElementById('modal-salvar-historico').style.display = 'none';
    }
    
    function abrirModalImportarHistorico() {
      const modal = document.getElementById('modal-importar-historico');
      const mesInput = document.getElementById('mes-importar-historico');
      mesInput.value = mesAtual();
      modal.style.display = 'block';
    }
    
    function fecharModalImportarHistorico() {
      document.getElementById('modal-importar-historico').style.display = 'none';
    }
    
    function salvarLeituraDoMesComSelecao() {
      const mesSelecionado = document.getElementById('mes-salvar-historico').value;
      if (!mesSelecionado) {
        alert("Por favor, selecione o mÃªs.");
        return;
      }
      const id = Number(new URLSearchParams(location.search).get("id"));
      salvarLeituraDoMes(id, mesSelecionado);
    }
    
    function salvarLeituraDoMes(blocoIndex, mesSelecionado) {
      const blocos = carregarBlocos();
      const bloco = blocos[blocoIndex];
      if (!bloco) { 
        alert("Bloco nÃ£o encontrado."); 
        return; 
      }

      const mes = mesSelecionado;
      bloco.historico = bloco.historico || {};
      
      if (bloco.historico[mes]) {
        if (!confirm(`JÃ¡ existe um histÃ³rico para o mÃªs ${formatarMesLabel(mes)}. Deseja sobrescrever?`)) {
          return;
        }
      }

      // 1) Grava no histÃ³rico
      bloco.historico[mes] = JSON.parse(JSON.stringify(bloco.leitura_atual || []));

      // 2) Exporta Excel
      const fazerExport = () => {
        const dados = bloco.historico[mes];
        const wsData = [
          ["HidrÃ´metro NÂº","ResponsÃ¡vel","Leitura Anterior","Leitura Atual","mÂ³","R$","ObservaÃ§Ãµes"],
          ...dados.map(apt => [
            apt.numero, apt.responsavel, apt.leitura_anterior, apt.leitura_atual, apt.total_m3, `R$ ${apt.total_rs}`, apt.obs
          ])
        ];
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Leitura");
        const nomeArquivo = `Leitura_${(bloco.nome||"Bloco")}_${mes}.xlsx`.replace(/\s+/g, "_");
        XLSX.writeFile(wb, nomeArquivo);
      };

      if (window.XLSX) {
        try { 
          fazerExport(); 
        } catch (e) { 
          console.error(e); 
          alert("Falha ao exportar Excel, mas o histÃ³rico foi salvo."); 
        }
      } else {
        alert("HistÃ³rico salvo. Para exportar Excel, verifique a conexÃ£o e recarregue a pÃ¡gina.");
      }

      // 3) Prepara prÃ³xima rodada
      bloco.leitura_atual = (bloco.leitura_atual || []).map(apt => ({
        numero: apt.numero,
        responsavel: apt.responsavel,
        leitura_anterior: apt.leitura_atual,
        leitura_atual: 0,
        total_m3: 0,
        total_rs: 0,
        obs: "",
        total_rs_base: 0
      }));

      salvarBlocos(blocos);
      
      // Chama renderizarBlocoIndividual se existir (serÃ¡ carregada do script.js)
      if (typeof renderizarBlocoIndividual === 'function') {
        renderizarBlocoIndividual();
      }
      
      showToast(`Leitura de ${formatarMesLabel(mes)} salva no histÃ³rico.`);
      fecharModalSalvarHistorico();
    }
    
    function importarHistoricoLeitura(event) {
      const file = event.target.files[0];
      if (!file) return;

      const mesSelecionado = document.getElementById('mes-importar-historico').value;
      if (!mesSelecionado) {
        alert("Por favor, selecione o mÃªs ao qual o histÃ³rico se refere.");
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];

          const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

          const blocos = carregarBlocos();
          const id = Number(new URLSearchParams(location.search).get("id"));
          const bloco = blocos[id];
          const tarifa = getTarifa(bloco);

          // ValidaÃ§Ã£o
          if (!json.length || !json[0]["HidrÃ´metro NÂº"]) {
            alert("O arquivo nÃ£o parece estar no formato de leitura esperado.");
            return;
          }

          // Processa dados
          const historicoImportado = [];
          json.forEach((row) => {
            const ant = Number(row["Leitura Anterior"]) || 0;
            const atu = Number(row["Leitura Atual"]) || 0;
            const m3 = Math.max(0, atu - ant);
            const valorRs = calcularValorEscalonado(m3, tarifa).toFixed(2);

            historicoImportado.push({
              numero: row["HidrÃ´metro NÂº"] || "",
              responsavel: row["ResponsÃ¡vel"] || "",
              leitura_anterior: ant,
              leitura_atual: atu,
              total_m3: m3,
              total_rs: valorRs,
              obs: row["ObservaÃ§Ãµes"] || ""
            });
          });

          // Salva no histÃ³rico
          bloco.historico = bloco.historico || {};
          const mesKey = mesSelecionado;

          if (bloco.historico[mesKey]) {
            if (!confirm(`JÃ¡ existe um histÃ³rico para o mÃªs ${formatarMesLabel(mesKey)}. Deseja sobrescrever?`)) {
              return;
            }
          }

          bloco.historico[mesKey] = historicoImportado;
          salvarBlocos(blocos);
          
          // Chama renderizarBlocoIndividual se existir
          if (typeof renderizarBlocoIndividual === 'function') {
            renderizarBlocoIndividual();
          }
          
          showToast(`HistÃ³rico de ${formatarMesLabel(mesKey)} importado com sucesso!`);
          fecharModalImportarHistorico();

        } catch (error) {
          console.error("Erro ao importar histÃ³rico:", error);
          alert("Erro ao processar o arquivo XLSX. Verifique se o arquivo estÃ¡ correto.");
        } finally {
          event.target.value = '';
        }
      };

      reader.readAsArrayBuffer(file);
    }

    // ==================== EXPORTAÃ‡ÃƒO/IMPORTAÃ‡ÃƒO LEITURA ATUAL ====================
    
    function exportarLeituraAtual() {
      if (typeof XLSX === 'undefined') {
        alert("Biblioteca XLSX nÃ£o carregada.");
        return;
      }

      const blocos = carregarBlocos();
      const id = Number(new URLSearchParams(window.location.search).get("id"));
      const bloco = blocos[id];
      if (!bloco) {
        alert("Bloco nÃ£o encontrado.");
        return;
      }

      const dados = bloco.leitura_atual || [];
      const worksheetData = [
        ["HidrÃ´metro NÂº","ResponsÃ¡vel","Leitura Anterior","Leitura Atual","mÂ³","R$","ObservaÃ§Ãµes"],
        ...dados.map(apt => [
          apt.numero,
          apt.responsavel,
          apt.leitura_anterior,
          apt.leitura_atual,
          apt.total_m3,
          `R$ ${apt.total_rs}`,
          apt.obs
        ])
      ];

      const ws = XLSX.utils.aoa_to_sheet(worksheetData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Leitura Atual");
      const mes = mesAtual().replace("-", "_");
      const nomeArquivo = `LeituraAtual_${(bloco.nome||"Bloco")}_${mes}.xlsx`.replace(/\s+/g, "_");
      XLSX.writeFile(wb, nomeArquivo);
    }

    function importarLeituraAtual(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        const blocos = carregarBlocos();
        const id = Number(new URLSearchParams(location.search).get("id"));
        const bloco = blocos[id];
        const tarifa = getTarifa(bloco);

        json.forEach((row, index) => {
          if (!bloco.leitura_atual[index]) return;

          const ant = Number(row["Leitura Anterior"]) || 0;
          const atu = Number(row["Leitura Atual"]) || 0;
          const m3 = Math.max(0, atu - ant);

          const apt = bloco.leitura_atual[index];
          apt.numero = row["HidrÃ´metro NÂº"] || apt.numero;
          apt.responsavel = row["ResponsÃ¡vel"] || "";
          apt.leitura_anterior = ant;
          apt.leitura_atual = atu;
          apt.total_m3 = m3;
          apt.total_rs = calcularValorEscalonado(m3, tarifa).toFixed(2);
          apt.obs = row["ObservaÃ§Ãµes"] || "";
        });

        salvarBlocos(blocos);
        alert("Leitura importada com sucesso!");
        
        // Chama renderizarBlocoIndividual se existir
        if (typeof renderizarBlocoIndividual === 'function') {
          renderizarBlocoIndividual();
        }
      };

      reader.readAsArrayBuffer(file);
    }
  </script>
</head>
<body>
  <div class="toolbar">
    <button class="voltar" aria-label="Voltar para o painel" onclick="window.location.href='dashboard.html'">ğŸ”™ Voltar</button>
    <div class="acoes">
      <button type="button" onclick="exportarLeituraAtual()">ğŸ“¤ Exportar Leitura Atual</button>
      <input type="file" id="importar-leitura-arquivo" accept=".xlsx" style="display:none" onchange="importarLeituraAtual(event)" />
      <button type="button" onclick="document.getElementById('importar-leitura-arquivo').click()">ğŸ“¥ Importar Leitura Atual (XLSX)</button>
      <button type="button" class="btn-danger" onclick="resetarBlocoPerguntar()">ğŸ—‘ï¸ Resetar Bloco</button>
      <button type="button" onclick="(function(){ const id=new URLSearchParams(location.search).get('id'); location.href='boletos.html?id='+encodeURIComponent(id||'0'); })()">ğŸ§¾ Boletos (imprimir)</button>
      <button type="button" onclick="abrirModalSalvarHistorico()">ğŸ’¾ Salvar Leitura do MÃªs</button>
      <button type="button" onclick="abrirModalImportarHistorico()">ğŸ“¥ Importar HistÃ³rico (XLSX)</button>
    </div>
  </div>

  <main id="bloco-detalhes" class="conteudo">
    <!-- Modal de Salvar HistÃ³rico -->
    <div id="modal-salvar-historico" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close-button" onclick="fecharModalSalvarHistorico()">&times;</span>
        <h2>Salvar Leitura no HistÃ³rico</h2>
        <p>Selecione o mÃªs ao qual esta leitura se refere:</p>
        <input type="month" id="mes-salvar-historico" required>
        <button onclick="salvarLeituraDoMesComSelecao()">Salvar Leitura</button>
      </div>
    </div>

    <!-- Modal de Importar HistÃ³rico -->
    <div id="modal-importar-historico" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close-button" onclick="fecharModalImportarHistorico()">&times;</span>
        <h2>Importar HistÃ³rico de Leitura</h2>
        <p>Selecione o mÃªs ao qual o arquivo de histÃ³rico se refere:</p>
        <input type="month" id="mes-importar-historico" required>
        <input type="file" id="importar-historico-arquivo" accept=".xlsx" onchange="importarHistoricoLeitura(event)" style="display:none;" />
        <button onclick="document.getElementById('importar-historico-arquivo').click()">Selecionar Arquivo XLSX</button>
        <p style="margin-top: 10px;">* O arquivo deve seguir o formato de exportaÃ§Ã£o de leitura.</p>
      </div>
    </div>
  </main>

  <!-- Modal de Captura de Foto -->
  <div id="modal-captura-foto" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModalCapturaFoto()">&times;</span>
      <h2>Capturar Foto do HidrÃ´metro</h2>
      <p>Apartamento: <strong id="foto-apt-nome"></strong></p>
      
      <div id="camera-view">
        <video id="video-stream" width="320" height="240" autoplay></video>
        <button onclick="capturarFoto()">Tirar Foto</button>
      </div>
      
      <div id="upload-view" style="display:none;">
        <input type="file" accept="image/*" onchange="uploadFoto(event)">
      </div>

      <canvas id="canvas-foto" width="320" height="240" style="display:none;"></canvas>
      <img id="foto-preview" src="" alt="PrÃ©via da Foto" style="display:none; max-width: 100%; height: auto;">
      
      <div class="modal-actions">
        <button onclick="salvarFoto()">Salvar Foto</button>
        <button onclick="alternarModoCaptura()">Alternar para Upload</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
</body>
</html>
