<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Leituras do Bloco | Leitura de Hidr√¥metro</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="logorecibo.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
  <script>
    if (localStorage.getItem("logado") !== "true") location.href = "index.html";

    // Verifica se a biblioteca XLSX foi carregada corretamente
    if (typeof XLSX === 'undefined') {
      alert("Biblioteca XLSX n√£o carregada. Verifique a conex√£o ou recarregue a p√°gina.");
    }

    // ==================== FUN√á√ïES AUXILIARES ====================
    
    function carregarBlocos() {
      return JSON.parse(localStorage.getItem("blocos")) || [];
    }
    
    function salvarBlocos(blocos) {
      localStorage.setItem("blocos", JSON.stringify(blocos));
    }
    
    function mesAtual() {
      const hoje = new Date();
      return `${hoje.getFullYear()}-${String(hoje.getMonth() + 1).padStart(2, "0")}`;
    }
    
    function formatarMesLabel(mes) {
      if (!mes) return "";
      const [ano, numeroMes] = mes.split("-");
      const meses = ["janeiro", "fevereiro", "mar√ßo", "abril", "maio", "junho", 
                     "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
      const mesNome = meses[parseInt(numeroMes, 10) - 1] || "";
      return `${mesNome}/${ano}`;
    }
    
    function getTarifa(bloco) {
      return bloco.tarifaConfig || {
        minimo: 10,
        faixa1_limite: 10,
        faixa1_preco: 5.00,
        faixa2_limite: 20,
        faixa2_preco: 7.50,
        faixa3_preco: 10.00
      };
    }
    
    function calcularValorEscalonado(m3, tarifa) {
      if (m3 <= tarifa.faixa1_limite) {
        return Math.max(tarifa.minimo, m3 * tarifa.faixa1_preco);
      } else if (m3 <= tarifa.faixa2_limite) {
        const valor1 = tarifa.faixa1_limite * tarifa.faixa1_preco;
        const valor2 = (m3 - tarifa.faixa1_limite) * tarifa.faixa2_preco;
        return valor1 + valor2;
      } else {
        const valor1 = tarifa.faixa1_limite * tarifa.faixa1_preco;
        const valor2 = (tarifa.faixa2_limite - tarifa.faixa1_limite) * tarifa.faixa2_preco;
        const valor3 = (m3 - tarifa.faixa2_limite) * tarifa.faixa3_preco;
        return valor1 + valor2 + valor3;
      }
    }

    // ==================== FUN√á√ïES DOS MODAIS ====================
    
    function abrirModalSalvarHistorico() {
      const modal = document.getElementById('modal-salvar-historico');
      const mesInput = document.getElementById('mes-salvar-historico');
      mesInput.value = mesAtual();
      modal.style.display = 'block';
    }
    
    function fecharModalSalvarHistorico() {
      document.getElementById('modal-salvar-historico').style.display = 'none';
    }
    
    function salvarLeituraDoMesComSelecao() {
      const mesSelecionado = document.getElementById('mes-salvar-historico').value;
      if (!mesSelecionado) {
        alert("Por favor, selecione o m√™s.");
        return;
      }
      
      const blocos = carregarBlocos();
      const id = Number(new URLSearchParams(location.search).get("id"));
      const bloco = blocos[id];
      
      if (!bloco) {
        alert("Bloco n√£o encontrado.");
        return;
      }
      
      const mes = mesSelecionado;
      bloco.historico = bloco.historico || {};
      
      // Verifica se j√° existe hist√≥rico para este m√™s
      if (bloco.historico[mes]) {
        if (!confirm(`J√° existe um hist√≥rico para o m√™s ${formatarMesLabel(mes)}. Deseja sobrescrever?`)) {
          return;
        }
      }
      
      // Salva no hist√≥rico
      bloco.historico[mes] = JSON.parse(JSON.stringify(bloco.leitura_atual || []));
      
      // Exporta para XLSX
      if (typeof XLSX !== 'undefined') {
        const dados = bloco.historico[mes];
        const worksheetData = [
          ["Hidr√¥metro N¬∫","Respons√°vel","Leitura Anterior","Leitura Atual","m¬≥","R$","Observa√ß√µes"],
          ...dados.map(apt => [
            apt.numero,
            apt.responsavel,
            apt.leitura_anterior,
            apt.leitura_atual,
            apt.total_m3,
            `R$ ${apt.total_rs}`,
            apt.obs
          ])
        ];
        
        const ws = XLSX.utils.aoa_to_sheet(worksheetData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, formatarMesLabel(mes));
        const mesFormatado = mes.replace("-", "_");
        const nomeArquivo = `Historico_${(bloco.nome||"Bloco")}_${mesFormatado}.xlsx`.replace(/\s+/g, "_");
        XLSX.writeFile(wb, nomeArquivo);
      }
      
      // Prepara pr√≥xima leitura
      bloco.leitura_atual = bloco.leitura_atual.map(apt => ({
        numero: apt.numero,
        responsavel: apt.responsavel,
        leitura_anterior: apt.leitura_atual,
        leitura_atual: apt.leitura_atual,
        total_m3: 0,
        total_rs: "0.00",
        obs: ""
      }));
      
      salvarBlocos(blocos);
      alert(`Leitura de ${formatarMesLabel(mes)} salva no hist√≥rico!`);
      fecharModalSalvarHistorico();
      
      // Recarrega a p√°gina para mostrar o hist√≥rico
      if (typeof renderizarBlocoIndividual === 'function') {
        renderizarBlocoIndividual();
      } else {
        location.reload();
      }
    }

    // Corrige o bot√£o de exporta√ß√£o
    function exportarLeituraAtual() {
      if (typeof XLSX === 'undefined') {
        alert("Biblioteca XLSX n√£o carregada.");
        return;
      }

      const blocos = carregarBlocos();
      const id = Number(new URLSearchParams(window.location.search).get("id"));
      const bloco = blocos[id];
      if (!bloco) {
        alert("Bloco n√£o encontrado.");
        return;
      }

      const dados = bloco.leitura_atual || [];
      const worksheetData = [
        ["Hidr√¥metro N¬∫","Respons√°vel","Leitura Anterior","Leitura Atual","m¬≥","R$","Observa√ß√µes"],
        ...dados.map(apt => [
          apt.numero,
          apt.responsavel,
          apt.leitura_anterior,
          apt.leitura_atual,
          apt.total_m3,
          `R$ ${apt.total_rs}`,
          apt.obs
        ])
      ];

      const ws = XLSX.utils.aoa_to_sheet(worksheetData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Leitura Atual");
      const mes = mesAtual().replace("-", "_");
      const nomeArquivo = `LeituraAtual_${(bloco.nome||"Bloco")}_${mes}.xlsx`.replace(/\s+/g, "_");
      XLSX.writeFile(wb, nomeArquivo);
    }

    // Importa√ß√£o de leitura
    function importarLeituraAtual(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        const blocos = carregarBlocos();
        const id = Number(new URLSearchParams(location.search).get("id"));
        const bloco = blocos[id];
        const tarifa = getTarifa(bloco);

        json.forEach((row, index) => {
          if (!bloco.leitura_atual[index]) return;

          const ant = Number(row["Leitura Anterior"]) || 0;
          const atu = Number(row["Leitura Atual"]) || 0;
          const m3 = Math.max(0, atu - ant);

          const apt = bloco.leitura_atual[index];
          apt.numero = row["Hidr√¥metro N¬∫"] || apt.numero;
          apt.responsavel = row["Respons√°vel"] || "";
          apt.leitura_anterior = ant;
          apt.leitura_atual = atu;
          apt.total_m3 = m3;
          apt.total_rs = calcularValorEscalonado(m3, tarifa).toFixed(2);
          apt.obs = row["Observa√ß√µes"] || "";
        });

        salvarBlocos(blocos);
        alert("Leitura importada com sucesso!");
        
        if (typeof renderizarBlocoIndividual === 'function') {
          renderizarBlocoIndividual();
        } else {
          location.reload();
        }
      };

      reader.readAsArrayBuffer(file);
    }
  </script>

  <div class="toolbar">
    <button class="voltar" aria-label="Voltar para o painel" onclick="window.location.href='dashboard.html'">üîô Voltar</button>
    <div class="acoes">
      <button type="button" onclick="exportarLeituraAtual()">üì§ Exportar Leitura Atual</button>
      <input type="file" id="importar-leitura-arquivo" accept=".xlsx" style="display:none" onchange="importarLeituraAtual(event)" />
      <button type="button" onclick="document.getElementById('importar-leitura-arquivo').click()">üì• Importar Leitura Atual (XLSX)</button>
      <button type="button" class="btn-danger" onclick="resetarBlocoPerguntar()">üóëÔ∏è Resetar Bloco</button>
      <button type="button" onclick="(function(){ const id=new URLSearchParams(location.search).get('id'); location.href='boletos.html?id='+encodeURIComponent(id||'0'); })()">üßæ Boletos (imprimir)</button>
      <button type="button" onclick="abrirModalSalvarHistorico()">üíæ Salvar Leitura do M√™s</button>
    </div>
  </div>

 <main id="bloco-detalhes" class="conteudo">
    <!-- Modal de Salvar Hist√≥rico -->
    <div id="modal-salvar-historico" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close-button" onclick="fecharModalSalvarHistorico()">&times;</span>
        <h2>üíæ Salvar Leitura no Hist√≥rico</h2>
        <p>Selecione o m√™s ao qual esta leitura se refere:</p>
        <input type="month" id="mes-salvar-historico" required style="width: 100%; padding: 8px; margin: 10px 0; font-size: 16px;">
        <div style="margin-top: 15px;">
          <button onclick="salvarLeituraDoMesComSelecao()" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">‚úÖ Salvar Leitura</button>
          <button onclick="fecharModalSalvarHistorico()" style="background: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px; font-size: 16px;">‚ùå Cancelar</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal de Captura de Foto -->
  <div id="modal-captura-foto" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-button" onclick="fecharModalCapturaFoto()">&times;</span>
      <h2>Capturar Foto do Hidr√¥metro</h2>
      <p>Apartamento: <strong id="foto-apt-nome"></strong></p>
      
      <div id="camera-view">
        <video id="video-stream" width="320" height="240" autoplay></video>
        <button onclick="capturarFoto()">Tirar Foto</button>
      </div>
      
      <div id="upload-view" style="display:none;">
        <input type="file" accept="image/*" onchange="uploadFoto(event)">
      </div>

      <canvas id="canvas-foto" width="320" height="240" style="display:none;"></canvas>
      <img id="foto-preview" src="" alt="Pr√©via da Foto" style="display:none; max-width: 100%; height: auto;">
      
      <div class="modal-actions">
        <button onclick="salvarFoto()">Salvar Foto</button>
        <button onclick="alternarModoCaptura()">Alternar para Upload</button>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
</body>
</html>
