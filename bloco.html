<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Leituras do Bloco | Leitura de HidrÃ´metro</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
  <script>
    if (localStorage.getItem("logado") !== "true") location.href = "index.html";

    // Verifica se a biblioteca XLSX foi carregada corretamente
    if (typeof XLSX === 'undefined') {
      alert("Biblioteca XLSX nÃ£o carregada. Verifique a conexÃ£o ou recarregue a pÃ¡gina.");
    }

    // Corrige o botÃ£o de exportaÃ§Ã£o
    function exportarLeituraAtual() {
      if (typeof XLSX === 'undefined') {
        alert("Biblioteca XLSX nÃ£o carregada.");
        return;
      }

      const blocos = carregarBlocos();
      const id = Number(new URLSearchParams(window.location.search).get("id"));
      const bloco = blocos[id];
      if (!bloco) {
        alert("Bloco nÃ£o encontrado.");
        return;
      }

      const dados = bloco.leitura_atual || [];
      const worksheetData = [
        ["HidrÃ´metro NÂº","ResponsÃ¡vel","Leitura Anterior","Leitura Atual","mÂ³","R$","ObservaÃ§Ãµes"],
        ...dados.map(apt => [
          apt.numero,
          apt.responsavel,
          apt.leitura_anterior,
          apt.leitura_atual,
          apt.total_m3,
          `R$ ${apt.total_rs}`,
          apt.obs
        ])
      ];

      const ws = XLSX.utils.aoa_to_sheet(worksheetData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Leitura Atual");
      const mes = mesAtual().replace("-", "_");
      const nomeArquivo = `LeituraAtual_${(bloco.nome||"Bloco")}_${mes}.xlsx`.replace(/\s+/g, "_");
      XLSX.writeFile(wb, nomeArquivo);
    }

    // ImportaÃ§Ã£o de leitura
    function importarLeituraAtual(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];

        const json = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

        const blocos = carregarBlocos();
        const id = Number(new URLSearchParams(location.search).get("id"));
        const bloco = blocos[id];
        const tarifa = getTarifa(bloco);

        json.forEach((row, index) => {
          if (!bloco.leitura_atual[index]) return;

          const ant = Number(row["Leitura Anterior"]) || 0;
          const atu = Number(row["Leitura Atual"]) || 0;
          const m3 = Math.max(0, atu - ant);

          const apt = bloco.leitura_atual[index];
          apt.numero = row["HidrÃ´metro NÂº"] || apt.numero;
          apt.responsavel = row["ResponsÃ¡vel"] || "";
          apt.leitura_anterior = ant;
          apt.leitura_atual = atu;
          apt.total_m3 = m3;
          apt.total_rs = calcularValorEscalonado(m3, tarifa).toFixed(2);
          apt.obs = row["ObservaÃ§Ãµes"] || "";
        });

        salvarBlocos(blocos);
        alert("Leitura importada com sucesso!");
        renderizarBlocoIndividual();
      };

      reader.readAsArrayBuffer(file);
    }
  </script>

  <div class="toolbar">
    <button class="voltar" aria-label="Voltar para o painel" onclick="window.location.href='dashboard.html'">ğŸ”™ Voltar</button>
    <div class="acoes">
      <button type="button" onclick="exportarLeituraAtual()">ğŸ“¤ Exportar Leitura Atual</button>
      <input type="file" id="importar-leitura-arquivo" accept=".xlsx" style="display:none" onchange="importarLeituraAtual(event)" />
      <button type="button" onclick="document.getElementById('importar-leitura-arquivo').click()">ğŸ“¥ Importar Leitura Atual (XLSX)</button>
      <button type="button" class="btn-danger" onclick="resetarBlocoPerguntar()">ğŸ—‘ï¸ Resetar Bloco</button>
      <button type="button" onclick="(function(){ const id=new URLSearchParams(location.search).get('id'); location.href='boletos.html?id='+encodeURIComponent(id||'0'); })()">ğŸ§¾ Boletos (imprimir)</button>
    </div>
  </div>

 <main id="bloco-detalhes" class="conteudo">
    <div class="calculator-container">
	      <div class="input-group">
	        <label for="contaSabesp">Valor da Conta Sabesp (R$):</label>
	        <input type="number" id="contaSabesp" step="0.01" placeholder="Ex: 1500.00" onchange="salvarContaSabesp();" />
	      </div>
      <h2>Calculadora de Conta de Ãgua</h2>
      <p>Preencha os campos abaixo para calcular o valor da sua conta.</p>

      <div class="input-group">
        <label for="consumo">Consumo (mÂ³):</label>
        <input type="number" id="consumo" placeholder="Ex: 15" onchange="calcularValor(); atualizarTextoExplicativo();" />
      </div>

      <div class="input-group">
        <label for="valorMinimo">Valor MÃ­nimo (R$):</label>
        <input type="number" id="valorMinimo" step="0.01" value="68.40" onchange="calcularValor(); atualizarTextoExplicativo();" />
      </div>

      <div class="input-group">
        <label for="valorM3">Valor por mÂ³ excedente (R$):</label>
        <input type="number" id="valorM3" step="0.01" value="8.59" onchange="calcularValor(); atualizarTextoExplicativo();" />
      </div>

      <div class="input-group">
        <label for="valorTotal">Total a pagar (R$):</label>
        <input type="text" id="valorTotal" readonly />
      </div>
    </div>

    <div id="textoExplicativo" class="result-box"></div>

    <div>
      <a id="whatsappLink" href="#" target="_blank">
        <button>Enviar cÃ¡lculo via WhatsApp</button>
      </a>
    </div>
  </main>

  <script src="script.js"></script>
</body>
</html>
